define("dsy/search/1.2.3/controller",["jquery","dsy/search/1.2.3/xf","dsy/search/1.2.3/esf","dsy/search/1.2.3/zf","dsy/search/1.2.3/jiaju","dsy/search/1.2.3/kuaixun","dsy/search/1.2.3/fangjia","dsy/search/1.2.3/haiwai","dsy/search/1.2.3/ditu"],function(require,exports,module){"use strict";var $=require("jquery");$.support.cors=!0;var vars=seajs.data.vars,tag4id={dsy_D02_02:"xf",dsy_D02_03:"esf",dsy_D02_04:"zf",dsy_D02_05:"jiaju",dsy_D02_06:"kuaixun",dsy_D02_20:"haiwai",dsy_D02_19:"fangjia",dsy_D02_21:"ditu"};!function(){var defaultHref={};vars.searchNavigate.each(function(idx,elem){var tag=tag4id[elem.id];tag&&(defaultHref[tag]=elem.href.replace(/\/$/,""))}),vars.searchDefaultHref=defaultHref}(),vars.searchDefaultText={tejia:"\u8bf7\u8f93\u5165\u5173\u952e\u5b57\uff08\u697c\u76d8\u540d\uff09",fangjia:"\u8bf7\u8f93\u5165\u5c0f\u533a\u540d\u79f0\u6216\u5730\u5740\uff0c\u7ed9\u81ea\u5df1\u7684\u623f\u5b50\u4f30\u4e2a\u4ef7",xf:"\u8bf7\u8f93\u5165\u5173\u952e\u5b57\uff08\u697c\u76d8\u540d/\u5730\u540d/\u5f00\u53d1\u5546\u7b49\uff09",esf:"\u8bf7\u8f93\u5165\u5173\u952e\u5b57\uff08\u697c\u76d8\u540d\u6216\u5730\u540d\uff09",zf:"\u8bf7\u8f93\u5165\u5173\u952e\u5b57\uff08\u697c\u76d8\u540d\u6216\u5730\u540d\uff09",jiaju:"\u8bf7\u8f93\u5165\u6237\u578b/\u529f\u80fd\u95f4/\u98ce\u683c\u7b49\u5173\u952e\u8bcd",kuaixun:"\u8bf7\u8f93\u5165\u5173\u952e\u5b57",haiwai:"\u8bf7\u8f93\u5165\u5173\u952e\u5b57(\u56fd\u5bb6/\u57ce\u5e02/\u5730\u533a)",ditu:"\u8bf7\u8f93\u5165\u533a\u53bf/\u5546\u5708/\u5c0f\u533a\u540d"};var allSearch={fangjia:require("dsy/search/1.2.3/fangjia"),xf:require("dsy/search/1.2.3/xf"),esf:require("dsy/search/1.2.3/esf"),zf:require("dsy/search/1.2.3/zf"),jiaju:require("dsy/search/1.2.3/jiaju"),kuaixun:require("dsy/search/1.2.3/kuaixun"),haiwai:require("dsy/search/1.2.3/haiwai"),ditu:require("dsy/search/1.2.3/ditu")},HomeSearch=function(){this.navigateArrowSelector=".searchjt",this.navigateActiveClass="cur",this.inputCache={tag:"",key:""},this.navigateTag="",this.requestText="",this.suggestListSelector="#suggest_list",this.historyListSelector="#history_list"},Prototype=HomeSearch.prototype;Prototype.init=function(){this.input=vars.searchInput,this.adImg=vars.searchInputAdvertImage,this.button=vars.searchButton,this.wrapper=vars.searchWrapper,this.navigate=vars.searchNavigate,this.navigateArrow=$(this.navigateArrowSelector),this.defaultText=vars.searchDefaultText,this.suggestList=$('<div id="suggest_list" style="display:none;"></div>').appendTo("body"),this.historyList=$('<div id="history_list" style="display:none;"></div>').appendTo("body"),this.boxHtml='<div class="search_select"><table cellspacing="0" border="0"><tbody></tbody></table></div>',this.vwgCallback(),this.bindNavigateEvent(),this.bindButtonEvent(),this.bindInputEvent(),this.bindWrapperEvent()},Prototype.clearClass=function(){this.navigateArrow.hide(),this.navigate.removeClass(this.navigateActiveClass)},Prototype.changeClass=function(index){this.navigateArrow.eq(index).show(),this.navigate.eq(index).addClass(this.navigateActiveClass)},Prototype.setNavigateTag=function(){var parent=this.navigate.parent(),id=parent.find(".cur").attr("id");this.navigateTag=tag4id[id]},Prototype.setInputCache=function(){var that=this,cache=that.inputCache,tag=that.navigateTag,key=that.input.val(),inputIsHistory=allSearch[tag].inputIsHistory(key),inputIsAdvert=allSearch[tag].inputIsAdvert(key),defaultText=that.defaultText[tag];!key||key===defaultText||inputIsAdvert||inputIsHistory||(cache.tag===tag&&cache.key!==key||!cache.key)&&(that.inputCache={tag:tag,key:key})},Prototype.clearInputCache=function(){this.inputCache={tag:"",key:""}},Prototype.vwgCallback=function(pvwg){vars.userType={dsy_D02_02:"xf",dsy_D02_03:"esf",dsy_D02_04:"zf"}[pvwg],this.adImg.hide();var vwg=pvwg||vars.vwg,index=$("#"+vwg).index();this.clearClass(),this.changeClass(index),this.setNavigateTag();var tag=this.navigateTag;allSearch[tag].setInputValue(),this.hoverCallAdvert()},Prototype.bindNavigateEvent=function(){var that=this;that.navigate.on("mouseover",function(){that.input.blur(),that.wrapper.empty().hide(),that.adImg.hide(),that.clearClass(),that.changeClass($(this).index()),that.setNavigateTag();var cache=that.inputCache,tag=that.navigateTag;cache.tag===tag&&cache.key?that.input.css("color","#333").val(cache.key):(allSearch[tag].setInputValue(),that.hoverCallAdvert())})},Prototype.bindButtonEvent=function(){var that=this;that.button.on("click",function(){clearInterval(that.timer);var input=that.input;that.wrapper.empty().hide(),that.input.blur(),that.clearInputCache();var key=input.val();that.navigateTag||that.setNavigateTag();var tag=that.navigateTag;return key&&key===that.defaultText[tag]&&(key=""),key=$.trim(key.replace(/\ +/g," ")),allSearch[tag].searchByKey(key,null,"button"),!1})},Prototype.bindInputEvent=function(){var that=this;that.input.on("focus",function(){var tag=that.navigateTag;tag||(that.setNavigateTag(),tag=that.navigateTag),that.adImg.hide();var cache=that.inputCache,input=$(this).css("color","#333");cache.tag===tag&&cache.key?(input.val(cache.key),input.setCursorPosition()):(input.val(""),that.clearInputCache());var key=input.val();return key?that.createSuggestList(key):"xf"===tag||"jiaju"===tag?that.createSuggestList(""):that.createHistoryList(),key||"xf"!==tag||allSearch[tag].setSessionAdvert({hasVoidSearch:1}),that.rebindInputKeyEvent(),that.watchInput(),!1}),that.input.on("blur",function(){clearInterval(that.timer),that.setInputCache()})},Prototype.rebindInputKeyEvent=function(){var that=this,wrapper=that.wrapper;that.input.off("keyup").on("keyup",function(e){var keyCode=e.keyCode;if(38===keyCode||40===keyCode){clearInterval(that.timer),that.isSelecting=!0;var tr=wrapper.find("tr"),trSelected=wrapper.find("tr.selected"),trIndex=trSelected.index();switch(trSelected.removeClass("selected").css("background-color","#FFFFFF"),keyCode){case 38:trSelected.length&&trIndex?tr.eq(trIndex-1).addClass("selected").css("background-color","#EDEDED"):wrapper.find("tr:last").addClass("selected").css("background-color","#EDEDED");break;case 40:trSelected.length&&trIndex!==tr.length-1?tr.eq(trIndex+1).addClass("selected").css("background-color","#EDEDED"):wrapper.find("tr:first").addClass("selected").css("background-color","#EDEDED")}var key=wrapper.find("tr.selected").attr("data-key");$(this).val(key)}}),that.input.off("keydown").on("keydown",function(e){var key=that.input.val(),keyCode=e.keyCode;if(key&&key===that.defaultText[that.navigateTag]&&that.input.val(""),that.isSelecting&&38!==keyCode&&40!==keyCode&&(that.watchInput(),that.isSelecting=!1),13===keyCode){var trSelected=wrapper.find("tr.selected"),tdClearHistory=trSelected.find("td.clear_history");tdClearHistory.length?tdClearHistory.trigger("click"):that.button.trigger("click")}})},Prototype.bindWrapperEvent=function(){var that=this;that.wrapper.on("click","tr",function(){clearInterval(that.timer);var key=$(this).attr("data-key"),so=$(this).attr("data-search")||$(this).attr("data-history"),json=JSON.parse(so);return allSearch[that.navigateTag].searchByKey(key,json,"list"),that.input.val(key),that.clearInputCache(),json.adUrl&&that.adImg.show(),!1}),that.wrapper.on("click",".remove_history",function(){clearInterval(that.timer);var index=$(this).parent().index(),tag=that.navigateTag;return allSearch[tag].removeHistoryItem(index),that.wrapper.hide(),that.createHistoryList(),!1}),that.wrapper.on("click",".clear_history",function(){clearInterval(that.timer);var tag=that.navigateTag;return allSearch[tag].clearHistory(),that.input.css("color","#888").val(that.defaultText[tag]).blur(),that.wrapper.hide(),that.createSuggestList(""),!1}),that.wrapper.on("mouseover","tr",function(){$(this).css("background-color","#EDEDED")}).on("mouseout","tr",function(){$(this).css("background-color","#FFFFFF")}),that.wrapper.on("mouseover","td.clear_history, td.remove_history",function(){$(this).css("color","#c00")}).on("mouseout","td.clear_history, td.remove_history",function(){$(this).css("color","#666")})},Prototype.watchInput=function(){var that=this;clearInterval(that.timer),that.requestText=that.input.val(),that.timer=window.setInterval(function(){var val=that.input.val();val!==that.requestText&&(val?(that.requestText=val,that.createSuggestList(val)):(that.requestText="",that.clearInputCache(),that.createHistoryList()))},1e3)},Prototype.createHistoryList=function(){var that=this,tag=that.navigateTag,html="",as=allSearch[tag],advertHtml=as.advertHtml,historyHtml=as.getHistoryHtml(3);historyHtml&&(html=("xf"===tag||"jiaju"===tag)&&advertHtml?historyHtml+advertHtml:as.getHistoryHtml()),html?that.wrapperShow(html,!0):that.createSuggestList("")},Prototype.createSuggestList=function(key){var tag=this.navigateTag;if("kuaixun"!==tag){var vv={tejia:"tejiafang",fangjia:"chafangjia",xf:"maixinfang",esf:"maiershoufang",zf:"zhaozufang",jiaju:"zhuangxiujiaju",haiwai:"haiwaifangchan",ditu:"mapfind"}[tag],param={q:escape(escape(key)),vv:vv,city:vars.sfsf.city,atype:4,cityEn:vars.cityCode};this.requestSuggest(param)}},Prototype.requestSuggest=function(param){var that=this;that.ajax&&(that.ajax.abort(),that.ajax=0),that.requestTag=that.navigateTag,vars.setRequestNumber();var url=vars.sfsf.url+"&timeFlag="+vars.getRequestNumber();that.ajax=$.ajax({type:"POST",url:url,data:param,crossDomain:!0,contentType:"application/x-www-form-urlencoded;charset=utf-8",async:!1,success:function(data){if(that.ajax=0,that.requestTag!==that.navigateTag)return!1;var tag=that.navigateTag,html="",as=allSearch[tag];if(data&&"error"!==data){as.getSuggestHtml(data);var suggestHtml=as.suggestHtml,advertHtml=as.advertHtml,historyHtml=as.getHistoryHtml(3);"xf"===tag?suggestHtml?html=suggestHtml:advertHtml&&(html=historyHtml+advertHtml):html="jiaju"===tag?param.q?suggestHtml:historyHtml?advertHtml?historyHtml+advertHtml:as.getHistoryHtml():advertHtml+suggestHtml:suggestHtml,html?that.wrapperShow(html,!1):that.wrapper.hide()}else param.q?that.wrapper.hide():as.getHistoryHtml(1)?that.createHistoryList():that.wrapper.hide();return!1},error:function(XMLHttpRequest,textStatus,error){console?console.log(error):window.FangSearchError=error}})},Prototype.wrapperShow=function(html,isHis){var thatList=isHis?this.historyList:this.suggestList,list=thatList.html(this.boxHtml);list.find("tbody").html(html),this.dropdown(list.html())},Prototype.hoverCallAdvert=function(){var that=this,tag=that.navigateTag;if("xf"!==tag&&"jiaju"!==tag)return!1;var sa=allSearch[tag].getSessionAdvert();if(sa&&sa.hasVoidSearch)return!1;var param={q:"",init:"true",cityEn:vars.cityCode};return"xf"===tag?param.vv="maixinfang":"jiaju"===tag&&(param.vv="zhuangxiujiaju"),that.requestAdvert(param),!0},Prototype.requestAdvert=function(param){var that=this;that.wrapper.hide(),that.ajax&&(that.ajax.abort(),that.ajax=0),that.requestTag=that.navigateTag,vars.setRequestNumber();var url=vars.sfsf.url+"&timeFlag="+vars.getRequestNumber();that.ajax=$.ajax({type:"POST",url:url,data:param,crossDomain:!0,contentType:"application/x-www-form-urlencoded;charset=utf-8",async:!1,success:function(data){return that.ajax=0,!(!data||"error"===data)&&(that.requestTag===that.navigateTag&&allSearch[that.navigateTag].setAdvert(data),!0)},error:function(XMLHttpRequest,textStatus,error){console?console.log(error):window.FangSearchError=error}})},module.exports=new HomeSearch});